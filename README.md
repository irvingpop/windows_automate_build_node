# windows_automate_build_node

This cookbook configures a Windows 2012R2 server with ChefDK to become a full Build Node (v1) for Chef Automate.

Unlike previous efforts, this cookbook is 100% standalone and includes no other dependencies, to demonstrate the most simplified Build Node bootstrapping mechanism possible.

## Usage:

It's easiest to download this cookbook to your Chef Automate server and run it from there (same as you would run `automate-ctl install-build-node`). It expects the `/etc/delivery` directory to be populated by a fully functioning Automate server.

Two bash scripts are provided, but it's recommended that you treat them as a reference and modify them to suit your environment:
* `bootstrap-windows-build-node.sh`: Connects to an existing Windows server (via `knife-windows`), bootstraps it with ChefDK and this cookbook in the run_list
 * NOTE: The Windows server must have WinRM enabled, and be accessible to the Automate server on ports 5985 and 5986 - see below for more details
* `provision-aws-windows-build-node.sh`: Launches a new Windows server in AWS (via `knife-ec2`), bootstraps it with ChefDK and this cookbook in the run_list
 * NOTE: you must install a valid `.aws/credentials` file to use this

This cookbook attempts to be totally unopinionated about how you've built your Automate server, but has been mostly tested using the [deltron](https://github.com/echohack/deltron) project and [AWS OpsWorks for Chef Automate](https://aws.amazon.com/opsworks/chefautomate/)

Set up your projects as normal, but any projects that depend on Windows build nodes will need to use Windows and v1/Push build nodes for all pipeline stages, with a config.json:

```json
{
  "version": "2",
  "build_cookbook": {
    "name": "build_cookbook",
    "path": ".delivery/build_cookbook"
  },
  "skip_phases": [
    "functional",
    "quality",
    "security",
    "smoke"
  ],
  "build_nodes": {
    "default": [ "tags:windows-build-node" ]
  },
  "dependencies": [],
  "delivery-truck": {
    "lint": {
      "enable_cookstyle": true
    },
    "publish": {
      "chef_server": true
    }
  }
}
```

## Prerequisites

* Chef Server must have Push Jobs Server 2.1.1 or newer installed, and TCP ports 10000-10003 available
* Automate server must have ChefDK installed: `curl https://omnitruck.chef.io/install.sh | sudo bash -s -- -P chefdk`
* Automate server must have TCP port 8989 (Git) open
* The user running the scripts (on the Automate server) must have:
  * a valid `~/.aws/credentials` file that can launch instances
  * access to the /etc/delivery/delivery.rb & /etc/delivery/delivery.pem files
* If using AWS Opsworks:
  1. In `/etc/delivery/delivery.rb`, modify the `delivery["chef_server"]` line to use the `https://delivery_fqdn` hostname instead of `https://localhost:8443`, or else modify the shell scripts to read `CHEF_SERVER` from the `/etc/opscode/chef-server.rb`
  2. Add the `pivotal` user to the `default` org:  `chef-server-ctl org-user-add default pivotal --admin`
  3. Ensure that the delivery process can read the right keys to execute push jobs:
  ```bash
  delivery-ctl stop delivery
  chgrp -R delivery /etc/delivery
  chmod g+r /etc/delivery/builder_key /etc/delivery/*.pem
  delivery-ctl start delivery
  ```

## Additional AWS usage notes

Launching a Windows 2012R2 instance in AWS using the `aws` CLI tools (and the `windows-build-node-user-data.txt` file generated by `provision-aws-windows-build-node.sh`).  NOTE: You still need to bootstrap the node using `bootstrap-windows-build-node.sh` after provisioning

```bash
aws ec2 run-instances \
  --count 1 \
  --image-id ami-24e64944 \
  --instance-type t2.medium \
  --key-name irving@getchef.com \
  --subnet-id subnet-ff2f279b \
  --security-group-ids sg-4a897632 \
  --user-data file://windows-build-node-user-data.txt \
  --block-device-mappings DeviceName=/dev/sda1,Ebs={VolumeType=gp2}
```

Creating a security group appropriate for Windows build nodes (they need tcp/5985 and tcp/5986 inbound for WinRM, and optionally 3389 for remote desktop protocol):

```bash
SGNAME="windows-build-nodes"
MYCIDR="10.42.0.0/16"
MYVPC="vpc-0012f067"
aws ec2 create-security-group --group-name $SGNAME --vpc-id $MYVPC --description "For Chef Automate Windows Build Nodes"

# fetch the VPC security group ID, requires jq command-line tool
SGID=`aws ec2 describe-security-groups --filters Name=group-name,Values=$SGNAME Name=vpc-id,Values=$MYVPC | jq ".SecurityGroups[0].GroupId" | tr -d \"`
aws ec2 authorize-security-group-ingress --group-id $SGID --protocol tcp --port 3389 --cidr $MYCIDR
aws ec2 authorize-security-group-ingress --group-id $SGID --protocol tcp --port 5985 --cidr $MYCIDR
aws ec2 authorize-security-group-ingress --group-id $SGID --protocol tcp --port 5986 --cidr $MYCIDR
```

### Re-running chef-client on your windows build nodes

With `knife winrm`
```bash
chef exec knife winrm "tags:windows-build-node" "chef-client -c c:/chef/client.rb" -a "ipaddress" -x chef -P VerySecurePassword
```

Or with `knife-push`, like the cool kids do
```bash
chef exec knife job start "chef-client" --search "tags:windows-build-node" --quorum 0
```


# Known Issues

## Windows 2012R2 MAX_PATH

Windows 2012R2 and earlier all have a maximum path length of 260 characters (Google: `MAX_PATH`).  Ruby programs that attempt to access a file who's path exceeds MAX_PATH will error or crash, which can easily happen in the Delivery workspace.

Workarounds:
* Use very short hostnames for your Chef and Automate servers, also use very short names for your projects (note: this is a terrible workaround)
* Use Windows 2016, which finally has the ability to lift this restriction:
  - https://mspoweruser.com/ntfs-260-character-windows-10/
  - https://www.saotn.org/ntfs-long-paths-windows-server-2016-gpo/

## ChefDK 1.1.6

* All pipeline stages fail when run via push jobs. Issue fixed in Chef master, but hasn't shipped yet: https://github.com/chef/chef/pull/5693
  * NOTE: This cookbook automatically patches a ChefDK 1.1.6 installation (see recipes/monkeypatch.rb) but that should be cleaned up when the next release of ChefDK ships, or switch to ChefDk from the current channel
* Push jobs needs updating to 2.1.4 to resolve an issue where jobs can hang if stdout or stderr exceed a certain size: https://github.com/chef/opscode-pushy-client/pull/111

## delivery-truck

* Deploy jobs fail because of improper consumption of workspace_path, pending PR merge to delivery-truck: https://github.com/chef-cookbooks/delivery-truck/pull/32

Workaround: Add the following to your `.delivery/build_cookbook/Berksfile`:

```
cookbook 'delivery-truck', git: 'https://github.com/chef-cookbooks/delivery-truck', branch: 'irving/fix_deploy_helper_search'
```
