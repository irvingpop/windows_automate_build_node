# windows_automate_build_node

This cookbook configures a Windows 2012R2 server with ChefDK to become a full Build Node (v1) for Chef Automate.

Unlike previous efforts, this cookbook is 100% standalone and includes no other dependencies, to demonstrate the most simplified Build Node bootstrapping mechanism possible.

## Usage:

It's easiest to download this cookbook to your Chef Automate server and run it from there (same as you would run `automate-ctl install-build-node`). It expects the `/etc/delivery` directory to be populated by a fully functioning Automate server.

Two bash scripts are provided, but it's recommended that you treat them as a reference and modify them to suit your environment:
* `bootstrap-windows-build-node.sh`: Connects to an existing Windows server (via `knife-windows`), bootstraps it with ChefDK and this cookbook in the run_list
 * NOTE: The Windows server must have WinRM enabled, and be accessible to the Automate server on ports 5985 and 5986 - see below for more details
* `provision-aws-windows-build-node.sh`: Launches a new Windows server in AWS (via `knife-ec2`), bootstraps it with ChefDK and this cookbook in the run_list
 * NOTE: you must install a valid `.aws/credentials` file to use this

This cookbook attempts to be totally unopinionated about how you've built your Automate server, but has been mostly tested using the [deltron](https://github.com/echohack/deltron) project

## Prerequisites

* Chef Server must have Push Jobs Server 2.1.1 or newer installed, and TCP ports 10000-10003 available
* Automate server must have ChefDK installed
* If using AWS Opsworks:
  1. modify the `delivery["chef_server"]` line to use the `https://delivery_fqdn` hostname instead of `https://localhost:8443`, or else modify the shell scripts to read `CHEF_SERVER` from the `/etc/opscode/chef-server.rb`
  2. Add the `pivotal` user to the `default` org:  `chef-server-ctl org-user-add default pivotal --admin`
* The user running the scripts (on the Automate server) must have:
  * a valid `~/.aws/credentials` file that can launch instances
  * access to the /etc/delivery/delivery.rb & /etc/delivery/delivery.pem files

## Additional AWS usage notes

Launching a Windows 2012R2 instance in AWS using the `aws` CLI tools (and the `windows-build-node-user-data.txt` file generated by `provision-aws-windows-build-node.sh`).  NOTE: You still need to bootstrap the node using `bootstrap-windows-build-node.sh` after provisioning

```bash
aws ec2 run-instances \
  --count 1 \
  --image-id ami-24e64944 \
  --instance-type t2.medium \
  --key-name irving@getchef.com \
  --subnet-id subnet-ff2f279b \
  --security-group-ids sg-4a897632 \
  --user-data file://windows-build-node-user-data.txt \
  --block-device-mappings DeviceName=/dev/sda1,Ebs={VolumeType=gp2}
```

Creating a security group appropriate for Windows build nodes (they need tcp/5985 and tcp/5986 inbound for WinRM, and optionally 3389 for remote desktop protocol):

```bash
SGNAME="windows-build-nodes"
MYCIDR="10.42.0.0/16"
MYVPC="vpc-0012f067"
aws ec2 create-security-group --group-name $SGNAME --vpc-id $MYVPC --description "For Chef Automate Windows Build Nodes"

# fetch the VPC security group ID, requires jq command-line tool
SGID=`aws ec2 describe-security-groups --filters Name=group-name,Values=$SGNAME Name=vpc-id,Values=$MYVPC | jq ".SecurityGroups[0].GroupId" | tr -d \"`
aws ec2 authorize-security-group-ingress --group-id $SGID --protocol tcp --port 3389 --cidr $MYCIDR
aws ec2 authorize-security-group-ingress --group-id $SGID --protocol tcp --port 5985 --cidr $MYCIDR
aws ec2 authorize-security-group-ingress --group-id $SGID --protocol tcp --port 5986 --cidr $MYCIDR
```

### Re-running chef-client on your windows build nodes

With `knife winrm`
```bash
chef exec knife winrm "tags:windows-build-node" "chef-client -c c:/chef/client.rb" -a "ipaddress" -x chef -P VerySecurePassword
```

Or with `knife-push`, like the cool kids do
```bash
chef exec knife job start "chef-client" --search "tags:windows-build-node" --quorum 0
```


# Known Issues

## ChefDK 1.1.6

* All pipeline stages fail when run via push jobs. Issue fixed in Chef master, but hasn't shipped yet: https://github.com/chef/chef/pull/5693
  * NOTE: This cookbook automatically patches a ChefDK installation (see recipes/monkeypatch.rb) but that should be cleaned up when the next release of ChefDK ships, or switch to ChefDk from the current channel
* Push jobs needs updating to 2.1.4 to resolve an issue where jobs can hang if stdout or stderr exceed a certain size: https://github.com/chef/opscode-pushy-client/pull/111

## delivery-truck

* Workspace path needs to be set in `attributes/default.rb`


* Deploy jobs fail because of improper consumption of workspace_path,  PR pending merge
