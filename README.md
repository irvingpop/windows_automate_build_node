# windows_automate_build_node

This cookbook configures a Windows 2012R2 server with ChefDK to become a full Build Node (v1) for Chef Automate.

Unlike previous efforts, this cookbook is 100% standalone and includes no other dependencies, to demonstrate the most simplified Build Node bootstrapping mechanism possible.

## Usage:

It's easiest to download this cookbook to your Chef Automate server and run it from there (same as you would run `automate-ctl install-build-node`). It expects the `/etc/delivery` directory to be populated by a fully functioning Automate server.

Two bash scripts are provided, but it's recommended that you treat them as a reference and modify them to suit your environment:
* `bootstrap-windows-build-node`: Connects to an existing Windows server (via `knife-windows`), bootstraps it with ChefDK and this cookbook in the run_list
 * NOTE: The Windows server must have WinRM enabled, and be accessible to the Automate server on ports 5985 and 5986 - see below for more details
* `provision-aws-windows-build-node.sh`: Launches a new Windows server in AWS (via `knife-ec2`), bootstraps it with ChefDK and this cookbook in the run_list
 * NOTE: you must install a valid `.aws/credentials` file to use this

This cookbook attempts to be totally unopinionated about how you've built your Automate server, but has been mostly tested using the [deltron](https://github.com/echohack/deltron) project

## Additional AWS usage notes

Launches a Windows 2012R2 instance in AWS using the `aws` CLI tools (and the `windows-build-node-user-data.txt` file generated by `provision-aws-windows-build-node.sh`):

```bash
aws ec2 run-instances \
  --count 1 \
  --image-id ami-24e64944 \
  --instance-type t2.medium \
  --key-name irving@getchef.com \
  --subnet-id subnet-ff2f279b \
  --security-group-ids sg-4a897632 \
  --user-data file://windows-build-node-user-data.txt \
  --block-device-mappings DeviceName=/dev/sda1,Ebs={VolumeType=gp2}
```

Creating a security group appropriate for Windows build nodes (they need tcp/5985 and tcp/5986 inbound for WinRM, and optionally 3389 for remote desktop protocol):

```bash
SGNAME="windows-build-nodes"
MYCIDR="10.42.0.0/16"
MYVPC="vpc-0012f067"
aws ec2 create-security-group --group-name $SGNAME --vpc-id $MYVPC --description "For Chef Automate Windows Build Nodes"

# fetch the VPC security group ID, requires jq command-line tool
SGID=`aws ec2 describe-security-groups --filters Name=group-name,Values=$SGNAME Name=vpc-id,Values=$MYVPC | jq ".SecurityGroups[0].GroupId" | tr -d \"`
aws ec2 authorize-security-group-ingress --group-id $SGID --protocol tcp --port 3389 --cidr $MYCIDR
aws ec2 authorize-security-group-ingress --group-id $SGID --protocol tcp --port 5985 --cidr $MYCIDR
aws ec2 authorize-security-group-ingress --group-id $SGID --protocol tcp --port 5986 --cidr $MYCIDR
```

### Re-running chef-client on your windows build nodes

With `knife winrm`
```bash
chef exec knife winrm "tags:windows-build-node" "chef-client -c c:/chef/client.rb" -a "ipaddress" -x chef -P VerySecurePassword
```

Or with `knife-push`, like the cool kids do
```bash
chef exec knife job start "chef-client" --search "tags:windows-build-node" --quorum 0
```
